<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Easy Proxies - ç›‘æ§æ§åˆ¶å°</title>
  <style>
    :root {
      --background: #ffffff;
      --foreground: #09090b;
      --card: #ffffff;
      --card-foreground: #09090b;
      --popover: #ffffff;
      --popover-foreground: #09090b;
      --primary: #18181b;
      --primary-foreground: #fafafa;
      --secondary: #f4f4f5;
      --secondary-foreground: #18181b;
      --muted: #f4f4f5;
      --muted-foreground: #71717a;
      --accent: #f4f4f5;
      --accent-foreground: #18181b;
      --destructive: #ef4444;
      --destructive-foreground: #fafafa;
      --border: #e4e4e7;
      --input: #e4e4e7;
      --ring: #18181b;
      --radius: 0.5rem;

      --success: #22c55e;
      --warning: #f59e0b;
      --blue: #3b82f6;

      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
        "Noto Sans CJK SC", "Source Han Sans SC", Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background-color: #fafafa;
      color: var(--foreground);
      font-family: var(--font-sans);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    h1, h2, h3 { margin: 0; letter-spacing: -0.025em; font-weight: 700; }
    .text-sm { font-size: 0.875rem; }
    .text-muted { color: var(--muted-foreground); }
    .font-mono { font-family: var(--font-mono); }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      background: var(--secondary);
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid var(--border);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted-foreground);
    }
    .status-dot.active {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }

    .controls-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
      padding: 1rem;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      align-items: center;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      height: 2.5rem;
      padding: 0 0.75rem;
      border-radius: calc(var(--radius) - 2px);
      border: 1px solid var(--input);
      background: transparent;
      font-size: 0.875rem;
      color: var(--foreground);
      font-family: inherit;
    }
    .search-input:focus { outline: none; border-color: var(--ring); }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 2.5rem;
      padding: 0 1rem;
      border-radius: calc(var(--radius) - 2px);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      gap: 0.5rem;
      white-space: nowrap;
      border: 1px solid transparent;
      font-family: inherit;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-sm {
      height: 2rem;
      padding: 0 0.75rem;
      font-size: 0.75rem;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--primary-foreground);
      border-color: var(--primary);
    }
    .btn-primary:hover { opacity: 0.9; }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--input);
      color: var(--foreground);
    }
    .btn-outline:hover { background: var(--accent); }

    .btn-destructive {
      background: var(--background);
      border: 1px solid var(--destructive);
      color: var(--destructive);
    }
    .btn-destructive:hover { background: #fef2f2; }

    .btn-ghost {
      background: transparent;
      border: none;
      padding: 0 0.5rem;
      color: var(--muted-foreground);
      height: auto;
    }
    .btn-ghost:hover { color: var(--foreground); }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .stat-title {
      font-size: 0.875rem;
      color: var(--muted-foreground);
      font-weight: 500;
    }
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      margin-top: 0.5rem;
      font-family: var(--font-mono);
      letter-spacing: -0.05em;
    }

    .node-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1rem;
    }

    .node-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      gap: 0.875rem;
    }

    .node-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 2px rgba(24, 24, 27, 0.08);
    }

    .node-card.status-error { border-left: 4px solid var(--destructive); }
    .node-card.status-warning { border-left: 4px solid var(--warning); }
    .node-card.status-healthy { border-left: 4px solid var(--success); }
    .node-card.status-blacklisted { border-left: 4px solid var(--foreground); opacity: 0.75; }

    .node-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
    .node-name { font-weight: 600; font-size: 1rem; line-height: 1.2; word-break: break-word; }
    .node-meta { font-size: 0.75rem; color: var(--muted-foreground); font-family: var(--font-mono); margin-top: 4px; }

    .node-error {
      display: none;
      font-size: 0.75rem;
      line-height: 1.35;
      color: var(--destructive);
      margin-top: 6px;
      word-break: break-word;
    }

    .latency-badge {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--muted-foreground);
      white-space: nowrap;
    }
    .latency-unit { font-size: 0.75rem; color: var(--muted-foreground); font-weight: 400; }

    .node-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.75rem;
      background: var(--secondary);
      padding: 0.75rem;
      border-radius: calc(var(--radius) - 4px);
    }
    .metric-row { display: flex; justify-content: space-between; gap: 0.75rem; }

    .node-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: auto;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    .node-details {
      border-top: 1px dashed var(--border);
      padding-top: 0.75rem;
    }

    .node-details summary {
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--muted-foreground);
      user-select: none;
    }

    .node-details summary::-webkit-details-marker { display: none; }

    .node-details summary::after {
      content: 'â–¸';
      float: right;
      color: var(--muted-foreground);
      transition: transform 0.2s;
    }

    .node-details[open] summary::after { transform: rotate(90deg); }

    .node-details-body { margin-top: 0.5rem; }

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.75rem;
      padding: 0.125rem 0;
      align-items: flex-start;
    }

    .detail-value {
      font-family: var(--font-mono);
      text-align: right;
      word-break: break-word;
      max-width: 65%;
    }

    .detail-value.error { color: var(--destructive); }

    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      display: none; align-items: center; justify-content: center;
      z-index: 50;
    }
    .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease-out; }

    .modal-content {
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      width: 100%;
      max-width: 450px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      animation: scaleIn 0.2s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
    .form-input {
      width: 100%;
      height: 2.5rem;
      padding: 0 0.75rem;
      border: 1px solid var(--input);
      border-radius: calc(var(--radius) - 2px);
      font-family: inherit;
    }

    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 100;
    }
    .toast {
      background: var(--background);
      border: 1px solid var(--border);
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      display: flex; align-items: center; gap: 0.75rem;
      min-width: 300px;
      animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--destructive); }
    .toast.info { border-left: 4px solid var(--blue); }

    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .tabs-nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .tab-btn {
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--muted-foreground);
      border-radius: var(--radius);
      transition: all 0.2s;
      background: transparent;
      border: 1px solid transparent;
      font-family: inherit;
    }

    .tab-btn:hover { color: var(--foreground); background: var(--accent); }
    .tab-btn.active { color: var(--foreground); background: var(--secondary); }

    .tab-btn:focus-visible {
      outline: 2px solid rgba(24, 24, 27, 0.25);
      outline-offset: 2px;
    }

    .view-section { display: none; }
    .view-section.active { display: block; }

    .text-success { color: var(--success); }
    .text-destructive { color: var(--destructive); }
    .text-warning { color: var(--warning); }
    .text-blue { color: var(--blue); }
    .full-width { width: 100%; }

    .config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      gap: 1rem;
    }
    .config-item:last-child { border-bottom: none; }

    .config-uri {
      max-width: 520px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 0.75rem;
      color: var(--muted-foreground);
      font-family: var(--font-mono);
    }

    .config-source-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.625rem;
      font-weight: 800;
      text-transform: uppercase;
      margin-left: 0.5rem;
      background: var(--secondary);
      color: var(--foreground);
      border: 1px solid var(--border);
    }
    .config-source-badge.nodes-file { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
    .config-source-badge.subscription { background: #fef3c7; color: #92400e; border-color: #fde68a; }
    .config-source-badge.inline { background: #dcfce7; color: #14532d; border-color: #bbf7d0; }

    .probe-bar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: transparent;
      z-index: 200;
    }
    .probe-fill {
      height: 100%;
      background: var(--foreground);
      width: 0%;
      transition: width 0.2s;
    }
  </style>
</head>
<body>
  <div class="probe-bar"><div id="probeFill" class="probe-fill"></div></div>

  <div class="container">
    <header>
      <div>
        <h1>Easy Proxies</h1>
        <div class="text-muted text-sm" style="margin-top: 4px;">èŠ‚ç‚¹ç›‘æ§ä¸ç®¡ç†ä¸­å¿ƒ</div>
      </div>
      <div style="text-align: right;">
        <div class="status-badge">
          <span class="status-dot" id="connectionDot"></span>
          <span id="lastUpdated">è¿æ¥ä¸­...</span>
        </div>
        <div style="margin-top: 0.5rem;">
          <button class="btn btn-ghost text-sm" type="button" onclick="app.ui.modals.open('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
          <button class="btn btn-ghost text-sm" type="button" onclick="app.auth.require()">ğŸ” é‡æ–°éªŒè¯</button>
        </div>
      </div>
    </header>

    <nav class="tabs-nav" role="tablist" aria-label="é¡µé¢åˆ‡æ¢">
      <button
        type="button"
        class="tab-btn active"
        role="tab"
        id="tab-monitor"
        aria-selected="true"
        aria-controls="view-monitor"
        tabindex="0"
        data-view="monitor"
        onclick="app.router.switch('monitor')"
      >ç›‘æ§é¢æ¿</button>
      <button
        type="button"
        class="tab-btn"
        role="tab"
        id="tab-manage"
        aria-selected="false"
        aria-controls="view-manage"
        tabindex="-1"
        data-view="manage"
        onclick="app.router.switch('manage')"
      >èŠ‚ç‚¹é…ç½®</button>
      <button
        type="button"
        class="tab-btn"
        role="tab"
        id="tab-debug"
        aria-selected="false"
        aria-controls="view-debug"
        tabindex="-1"
        data-view="debug"
        onclick="app.router.switch('debug')"
      >è°ƒè¯•æ•°æ®</button>
    </nav>

    <main id="view-monitor" class="view-section active" role="tabpanel" aria-labelledby="tab-monitor">
      <div class="stats-grid">
        <div class="card">
          <div class="stat-title">æ€»èŠ‚ç‚¹æ•°</div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="card">
          <div class="stat-title">å¥åº·å¯ç”¨</div>
          <div class="stat-value text-success" id="stat-healthy">0</div>
        </div>
        <div class="card">
          <div class="stat-title">æ´»è·ƒè¿æ¥</div>
          <div class="stat-value text-blue" id="stat-active">0</div>
        </div>
        <div class="card">
          <div class="stat-title">å¼‚å¸¸/æ‹‰é»‘</div>
          <div class="stat-value text-destructive" id="stat-error">0</div>
        </div>
        <div class="card" id="subscriptionCard" style="display:none;">
          <div class="stat-title">è®¢é˜…èŠ‚ç‚¹</div>
          <div class="stat-value" id="subNodeCount">0</div>
          <div id="subStatusLine" class="text-muted text-sm" style="margin-top: 0.5rem;">â€”</div>
        </div>
      </div>

      <div class="controls-bar">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="æœç´¢èŠ‚ç‚¹åç§°æˆ– Tag..."
          aria-label="æœç´¢èŠ‚ç‚¹åç§°æˆ– Tag"
          oninput="app.render.filterNodes()"
        >
        <select
          id="sortSelect"
          class="search-input"
          style="flex: 0; min-width: 180px;"
          onchange="app.render.filterNodes()"
          aria-label="æ’åº"
        >
          <option value="default">é»˜è®¤æ’åºï¼ˆåç«¯é¡ºåºï¼‰</option>
          <option value="latency">æŒ‰å»¶è¿Ÿ (ä½â†’é«˜)</option>
          <option value="success">æŒ‰å¼‚å¸¸æ¬¡æ•° (å°‘â†’å¤š)</option>
        </select>

        <div style="height: 20px; width: 1px; background: var(--border); margin: 0 0.5rem;"></div>

        <button class="btn btn-outline" type="button" onclick="app.actions.refresh()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
          åˆ·æ–°
        </button>
        <button class="btn btn-primary" type="button" onclick="app.actions.probeAll()">âš¡ å…¨éƒ¨æ¢æµ‹</button>
        <button class="btn btn-outline" type="button" id="refreshSubBtn" style="display:none;" onclick="app.actions.refreshSubscription()">åˆ·æ–°è®¢é˜…</button>
        <button class="btn btn-outline" type="button" onclick="app.actions.export()">å¯¼å‡º</button>
      </div>

      <div id="monitorGrid" class="node-grid"></div>

      <div id="monitorEmpty" class="card" style="text-align: center; padding: 4rem; display: none;">
        <h3 class="text-muted">æ— ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹</h3>
        <p class="text-muted text-sm">è¯·å°è¯•æ¸…é™¤æœç´¢æˆ–æ·»åŠ æ–°èŠ‚ç‚¹</p>
      </div>
    </main>

    <main id="view-manage" class="view-section" role="tabpanel" aria-labelledby="tab-manage" hidden>
      <div class="controls-bar" style="justify-content: space-between;">
        <div>
          <h2 class="text-sm">èŠ‚ç‚¹é…ç½®ç®¡ç†</h2>
          <p class="text-muted text-sm" style="margin-top: 2px;">ç®¡ç†èŠ‚ç‚¹é…ç½®ï¼ˆæ¥æºï¼šnodes_file / subscription / inlineï¼‰</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-primary" type="button" onclick="app.ui.modals.openNode()">+ æ·»åŠ èŠ‚ç‚¹</button>
          <button class="btn btn-destructive" type="button" onclick="app.actions.reloadConfig()">é‡è½½é…ç½® (ç”Ÿæ•ˆ)</button>
        </div>
      </div>

      <div id="subscriptionHint" class="card" style="margin-bottom: 1rem; background: #fff7ed; border-color: #fdba74; display: none;">
        <p class="text-warning text-sm font-mono">âš ï¸ æ£€æµ‹åˆ° subscription æ¥æºèŠ‚ç‚¹ï¼šåˆ·æ–°è®¢é˜…åï¼Œæœ¬åœ°ä¿®æ”¹å¯èƒ½è¢«è¦†ç›–ï¼›è®¢é˜…èŠ‚ç‚¹åœ¨æ­¤é¡µä¸ºåªè¯»ã€‚</p>
      </div>

      <div class="card" style="padding: 0;">
        <div id="configList"></div>
        <div id="configEmpty" style="padding: 2rem; text-align: center; display: none;">æš‚æ— é…ç½®èŠ‚ç‚¹</div>
      </div>

      <div class="card" style="margin-top: 1rem; background: #fff7ed; border-color: #fdba74;">
        <p class="text-warning text-sm font-mono">âš ï¸ æ³¨æ„ï¼šç‚¹å‡»â€œé‡è½½é…ç½®â€ä¼šä¸­æ–­å½“å‰æ‰€æœ‰è¿æ¥å¹¶é‡æ–°åŠ è½½é…ç½®ã€‚</p>
      </div>
    </main>

    <main id="view-debug" class="view-section" role="tabpanel" aria-labelledby="tab-debug" hidden>
      <div class="stats-grid">
        <div class="card">
          <div class="stat-title">æ€»è°ƒç”¨æ¬¡æ•°</div>
          <div class="stat-value" id="debug-calls">0</div>
        </div>
        <div class="card">
          <div class="stat-title">æ•´ä½“æˆåŠŸç‡</div>
          <div class="stat-value" id="debug-rate">0%</div>
        </div>
      </div>
      <div id="debugGrid" class="node-grid"></div>
    </main>
  </div>

  <div id="modal-login" class="modal-overlay">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h2 id="loginTitle" style="margin-bottom: 1rem;">ğŸ” èº«ä»½éªŒè¯</h2>
      <form onsubmit="app.auth.login(event)">
        <div class="form-group">
          <label class="form-label" for="loginPass">ç®¡ç†å¯†ç </label>
          <input type="password" id="loginPass" class="form-input" required>
        </div>
        <button class="btn btn-primary full-width" type="submit">è¿›å…¥æ§åˆ¶å°</button>
      </form>
    </div>
  </div>

  <div id="modal-node" class="modal-overlay">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalNodeTitle">
      <h2 style="margin-bottom: 1rem;" id="modalNodeTitle">æ·»åŠ èŠ‚ç‚¹</h2>
      <form onsubmit="app.actions.saveNode(event)">
        <input type="hidden" id="nodeEditTarget">
        <div class="form-group">
          <label class="form-label" for="nodeName">èŠ‚ç‚¹åç§°</label>
          <input type="text" id="nodeName" class="form-input" placeholder="My Proxy">
        </div>
        <div class="form-group">
          <label class="form-label" for="nodeUri">èŠ‚ç‚¹ URI</label>
          <input type="text" id="nodeUri" class="form-input" required placeholder="vless://...">
        </div>
        <div class="form-group">
          <label class="form-label" for="nodePort">ç«¯å£ (å¯é€‰)</label>
          <input type="number" id="nodePort" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨åˆ†é…">
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
          <button type="button" class="btn btn-outline full-width" onclick="app.ui.modals.close()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary full-width">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-settings" class="modal-overlay">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <h2 id="settingsTitle" style="margin-bottom: 1rem;">ç³»ç»Ÿè®¾ç½®</h2>
      <form onsubmit="app.actions.saveSettings(event)">
        <div class="form-group">
          <label class="form-label" for="setExtIp">å¤–éƒ¨ IP (å¯¼å‡ºç”¨)</label>
          <input type="text" id="setExtIp" class="form-input" placeholder="1.2.3.4">
        </div>
        <div class="form-group">
          <label class="form-label" for="setProbe">æ¢æµ‹ç›®æ ‡</label>
          <input type="text" id="setProbe" class="form-input" placeholder="www.google.com:80">
        </div>
        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="setCert" style="width: 1.2rem; height: 1.2rem;">
          <label for="setCert" class="form-label" style="margin: 0;">è·³è¿‡è¯ä¹¦éªŒè¯ (Insecure)</label>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
          <button type="button" class="btn btn-outline full-width" onclick="app.ui.modals.close()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary full-width">ä¿å­˜è®¾ç½®</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <script>
    const app = (() => {
      const state = {
        nodes: [],
        configNodes: [],
        debugStats: {},

        subscription: null,
        subscriptionLastFetch: 0,
        subscriptionStatusInFlight: false,
        subscriptionRefreshInFlight: false,

        filter: '',
        sortBy: 'default',

        isAuthenticated: false,
        refreshInFlight: false,
        probeAllInFlight: false,
        autoRefreshTimer: null
      };

      const nodeCardMap = new Map(); // tag -> HTMLElement

      const api = {
        async request(endpoint, options = {}) {
          try {
            const res = await fetch(endpoint, options);

            const contentType = res.headers.get("content-type") || "";
            const isJSON = contentType.includes("application/json");
            const isAuthEndpoint = endpoint === "/api/auth";

            if (res.status === 401) {
              let msg = "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•";
              if (isJSON) {
                try {
                  const data = await res.json();
                  if (data && data.error) msg = data.error;
                } catch (_) {}
              }

              if (!isAuthEndpoint) {
                app.auth.require();
                throw new Error("Unauthorized");
              }
              throw new Error(msg);
            }

            if (isJSON) {
              const data = await res.json();
              if (data && data.error) throw new Error(data.error);
              if (!res.ok) throw new Error("Request failed");
              return data;
            }

            if (!res.ok) throw new Error(`Request failed (${res.status})`);
            return res;
          } catch (err) {
            if (err.message !== "Unauthorized") utils.toast(err.message, "error");
            throw err;
          }
        },

        getNodes: () => api.request('/api/nodes'),
        getConfig: () => api.request('/api/nodes/config'),
        getDebug: () => api.request('/api/debug'),
        getSettings: () => api.request('/api/settings'),

        getSubscriptionStatus: () => api.request('/api/subscription/status'),
        refreshSubscription: () => api.request('/api/subscription/refresh', { method: 'POST' }),

        probe: (tag) => api.request(`/api/nodes/${encodeURIComponent(tag)}/probe`, { method: 'POST' }),
        release: (tag) => api.request(`/api/nodes/${encodeURIComponent(tag)}/release`, { method: 'POST' }),

        saveNode: (data, isEdit, oldName) => {
          const url = isEdit ? `/api/nodes/config/${encodeURIComponent(oldName)}` : '/api/nodes/config';
          return api.request(url, {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        },

        deleteNode: (name) => api.request(`/api/nodes/config/${encodeURIComponent(name)}`, { method: 'DELETE' }),
        reload: () => api.request('/api/reload', { method: 'POST' }),

        saveSettings: (data) => api.request('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }),

        export: () => fetch('/api/export'),

        login: (password) => api.request('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        })
      };

      const utils = {
        toast: (msg, type='info') => {
          const el = document.createElement('div');
          el.className = `toast ${type}`;
          el.textContent = msg;
          document.getElementById('toastContainer').appendChild(el);
          setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(10px)';
            setTimeout(() => el.remove(), 300);
          }, 3000);
        },

        copyToClipboard: async (text) => {
          const str = String(text ?? '');
          if (!str) return;

          const tryClipboard = async () => {
            if (!navigator.clipboard || !navigator.clipboard.writeText) return false;
            if (!window.isSecureContext) return false;
            try {
              await navigator.clipboard.writeText(str);
              return true;
            } catch (_) {
              return false;
            }
          };

          const tryExecCommand = () => {
            const textarea = document.createElement('textarea');
            textarea.value = str;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, textarea.value.length);

            let ok = false;
            try {
              ok = document.execCommand('copy');
            } catch (_) {
              ok = false;
            }
            document.body.removeChild(textarea);
            return ok;
          };

          const ok = await tryClipboard() || tryExecCommand();
          if (ok) utils.toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
          else utils.toast('å¤åˆ¶å¤±è´¥ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰', 'error');
        },

        esc: (v) => {
          const s = String(v ?? '');
          return s
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
        },

        _parseTime: (timeStr) => {
          if (!timeStr || timeStr === '0001-01-01T00:00:00Z') return null;
          const t = Date.parse(timeStr);
          if (!Number.isFinite(t)) return null;
          return new Date(t);
        },

        formatTimeLocal: (timeStr) => {
          const d = utils._parseTime(timeStr);
          if (!d) return 'ä»æœª';
          return d.toLocaleString('zh-CN');
        },

        formatTimeAgo: (timeStr) => {
          const d = utils._parseTime(timeStr);
          if (!d) return 'ä»æœª';

          const diff = Math.floor((Date.now() - d.getTime()) / 1000);
          if (diff < 0) return 'åˆšåˆš';
          if (diff < 60) return `${diff}ç§’å‰`;
          if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
          if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`;
          return `${Math.floor(diff / 86400)}å¤©å‰`;
        }
      };

      const render = {
        createNodeCard: (tag) => {
          const div = document.createElement('div');
          div.className = 'node-card';
          div.dataset.tag = tag;

          div.innerHTML = `
            <div class="node-header">
              <div style="min-width:0;">
                <div class="node-name"></div>
                <div class="node-meta text-muted"></div>
                <div class="node-error"></div>
              </div>
              <div class="latency-badge"><span class="val"></span><span class="latency-unit">ms</span></div>
            </div>

            <div class="node-metrics">
              <div class="metric-row"><span class="text-muted">å…¥å£ç«¯å£</span><span class="m-port font-mono"></span></div>
              <div class="metric-row"><span class="text-muted">è¿æ¥</span><span class="m-conn font-mono"></span></div>
              <div class="metric-row"><span class="text-muted">å¤±è´¥</span><span class="m-fail font-mono"></span></div>
              <div class="metric-row"><span class="text-muted">æ¨¡å¼</span><span class="m-mode font-mono"></span></div>
            </div>

            <details class="node-details">
              <summary class="node-details-summary">è¯¦æƒ…</summary>
              <div class="node-details-body">
                <div class="detail-row"><span class="text-muted">æœ€è¿‘æˆåŠŸ</span><span class="detail-value d-success"></span></div>
                <div class="detail-row"><span class="text-muted">æœ€è¿‘å¤±è´¥</span><span class="detail-value d-failure"></span></div>
                <div class="detail-row d-error-row" style="display:none;">
                  <span class="text-muted">æœ€è¿‘é”™è¯¯</span><span class="detail-value error d-error"></span>
                </div>
                <div class="detail-row d-blacklisted-row" style="display:none;">
                  <span class="text-muted">æ‹‰é»‘è‡³</span><span class="detail-value d-blacklisted"></span>
                </div>
              </div>
            </details>

            <div class="node-actions">
              <button class="btn btn-outline btn-sm full-width action-probe" type="button">Ping</button>
              <button class="btn btn-outline btn-sm action-copy" type="button" title="å¤åˆ¶Tag">Copy</button>
              <button class="btn btn-destructive btn-sm action-release" type="button" style="display:none;">è§£å°</button>
            </div>
          `;

          const refs = {
            name: div.querySelector('.node-name'),
            meta: div.querySelector('.node-meta'),
            errorLine: div.querySelector('.node-error'),

            latencyVal: div.querySelector('.latency-badge .val'),
            latencyUnit: div.querySelector('.latency-unit'),

            port: div.querySelector('.m-port'),
            conn: div.querySelector('.m-conn'),
            fail: div.querySelector('.m-fail'),
            mode: div.querySelector('.m-mode'),

            success: div.querySelector('.d-success'),
            failure: div.querySelector('.d-failure'),

            errorRow: div.querySelector('.d-error-row'),
            errorDetail: div.querySelector('.d-error'),

            blacklistedRow: div.querySelector('.d-blacklisted-row'),
            blacklistedUntil: div.querySelector('.d-blacklisted'),

            probeBtn: div.querySelector('.action-probe'),
            copyBtn: div.querySelector('.action-copy'),
            releaseBtn: div.querySelector('.action-release')
          };

          refs.probeBtn.onclick = () => app.actions.probeSingle(tag);
          refs.releaseBtn.onclick = () => app.actions.releaseSingle(tag);
          refs.copyBtn.onclick = () => utils.copyToClipboard(tag);

          div._refs = refs;
          return div;
        },

        updateNodeCard: (el, node) => {
          const refs = el._refs;

          const failures = Number.isFinite(node.failure_count) ? node.failure_count : 0;

          let status = 'healthy';
          if (node.blacklisted) status = 'blacklisted';
          else if (failures >= 2) status = 'error';
          else if (failures >= 1) status = 'warning';
          el.className = `node-card status-${status}`;

          const setText = (target, v) => {
            const s = String(v ?? '');
            if (target.textContent !== s) target.textContent = s;
          };

          setText(refs.name, node.name || node.tag || '');
          setText(refs.meta, node.tag || '');

          const lastErrorFull = typeof node.last_error === 'string' ? node.last_error.trim() : '';
          if (lastErrorFull) {
            const short = lastErrorFull.length > 90 ? lastErrorFull.slice(0, 90) + 'â€¦' : lastErrorFull;
            refs.errorLine.style.display = 'block';
            refs.errorLine.textContent = short;
            refs.errorLine.title = lastErrorFull;

            refs.errorRow.style.display = 'flex';
            refs.errorDetail.textContent = lastErrorFull;
            refs.errorDetail.title = lastErrorFull;
          } else {
            refs.errorLine.style.display = 'none';
            refs.errorLine.textContent = '';
            refs.errorLine.title = '';

            refs.errorRow.style.display = 'none';
            refs.errorDetail.textContent = '';
            refs.errorDetail.title = '';
          }

          const lat = Number.isFinite(node.last_latency_ms) ? node.last_latency_ms : -1;
          if (lat < 0) {
            setText(refs.latencyVal, '--');
            refs.latencyVal.style.color = '';
            refs.latencyUnit.style.display = 'none';
          } else {
            setText(refs.latencyVal, lat);
            refs.latencyUnit.style.display = 'inline';
            refs.latencyVal.style.color =
              lat < 100 ? 'var(--success)' :
              lat < 300 ? 'var(--blue)' :
              lat < 800 ? 'var(--warning)' :
              'var(--destructive)';
          }

          const portNum = Number(node.port);
          const portText = Number.isFinite(portNum) && portNum > 0 ? String(portNum) : 'â€”';
          setText(refs.port, portText);

          const conns = Number.isFinite(node.active_connections) ? node.active_connections : 0;
          setText(refs.conn, conns);

          setText(refs.fail, failures);
          setText(refs.mode, node.mode || 'â€”');

          setText(refs.success, utils.formatTimeAgo(node.last_success));
          refs.success.title = utils.formatTimeLocal(node.last_success);

          setText(refs.failure, utils.formatTimeAgo(node.last_failure));
          refs.failure.title = utils.formatTimeLocal(node.last_failure);

          if (node.blacklisted && node.blacklisted_until && node.blacklisted_until !== '0001-01-01T00:00:00Z') {
            refs.blacklistedRow.style.display = 'flex';
            setText(refs.blacklistedUntil, utils.formatTimeLocal(node.blacklisted_until));
          } else {
            refs.blacklistedRow.style.display = 'none';
            setText(refs.blacklistedUntil, '');
          }

          refs.releaseBtn.style.display = node.blacklisted ? 'inline-flex' : 'none';
        },

        monitor: () => {
          const grid = document.getElementById('monitorGrid');

          const allNodes = Array.isArray(state.nodes) ? state.nodes.filter(n => n && n.tag) : [];

          const term = String(state.filter || '').trim().toLowerCase();
          let viewNodes = allNodes;

          if (term) {
            viewNodes = allNodes.filter(n => {
              const tag = String(n.tag || '').toLowerCase();
              const name = String(n.name || '').toLowerCase();
              return tag.includes(term) || name.includes(term);
            });
          }

          if (state.sortBy === 'latency') {
            viewNodes = [...viewNodes].sort((a, b) => {
              const al = Number.isFinite(a.last_latency_ms) && a.last_latency_ms >= 0 ? a.last_latency_ms : 1e9;
              const bl = Number.isFinite(b.last_latency_ms) && b.last_latency_ms >= 0 ? b.last_latency_ms : 1e9;
              return al - bl;
            });
          } else if (state.sortBy === 'success') {
            viewNodes = [...viewNodes].sort((a, b) => {
              const af = Number.isFinite(a.failure_count) ? a.failure_count : 0;
              const bf = Number.isFinite(b.failure_count) ? b.failure_count : 0;
              return af - bf;
            });
          }
          // default: ä¿æŒåç«¯é¡ºåºï¼ˆstate.nodes åŸé¡ºåºï¼‰

          const frag = document.createDocumentFragment();
          const seen = new Set();

          for (const node of viewNodes) {
            const tag = node.tag;
            if (!tag || seen.has(tag)) continue;
            seen.add(tag);

            let card = nodeCardMap.get(tag);
            if (!card) {
              card = render.createNodeCard(tag);
              nodeCardMap.set(tag, card);
            }

            render.updateNodeCard(card, node);
            frag.appendChild(card);
          }

          grid.replaceChildren(frag);

          document.getElementById('monitorEmpty').style.display = viewNodes.length === 0 ? 'block' : 'none';

          const healthy = allNodes.filter(n => !n.blacklisted && (Number.isFinite(n.failure_count) ? n.failure_count : 0) === 0).length;
          const active = allNodes.reduce((acc, n) => acc + (Number.isFinite(n.active_connections) ? n.active_connections : 0), 0);
          const errors = allNodes.filter(n => n.blacklisted || (Number.isFinite(n.failure_count) ? n.failure_count : 0) > 0).length;

          document.getElementById('stat-total').textContent = String(allNodes.length);
          document.getElementById('stat-healthy').textContent = String(healthy);
          document.getElementById('stat-active').textContent = String(active);
          document.getElementById('stat-error').textContent = String(errors);

          const backendTags = new Set(allNodes.map(n => n.tag));
          for (const tag of Array.from(nodeCardMap.keys())) {
            if (!backendTags.has(tag)) nodeCardMap.delete(tag);
          }
        },

        subscription: () => {
          const card = document.getElementById('subscriptionCard');
          const btn = document.getElementById('refreshSubBtn');
          const countEl = document.getElementById('subNodeCount');
          const lineEl = document.getElementById('subStatusLine');

          if (!card || !btn || !countEl || !lineEl) return;

          const s = state.subscription;
          if (!s || !s.enabled) {
            card.style.display = 'none';
            btn.style.display = 'none';
            return;
          }

          card.style.display = 'block';
          btn.style.display = 'inline-flex';

          const disabled = !!state.subscriptionRefreshInFlight || !!s.is_refreshing;
          btn.disabled = disabled;
          btn.textContent = disabled ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°è®¢é˜…';

          countEl.textContent = String(s.node_count || 0);

          lineEl.className = 'text-muted text-sm';
          lineEl.title = '';

          if (s.is_refreshing) {
            lineEl.textContent = 'çŠ¶æ€: åˆ·æ–°ä¸­...';
            lineEl.className = 'text-warning text-sm';
            return;
          }

          if (s.last_error) {
            lineEl.textContent = 'ä¸Šæ¬¡å¤±è´¥: ' + String(s.last_error);
            lineEl.className = 'text-destructive text-sm';
            lineEl.title = String(s.last_error);
            return;
          }

          if (s.last_refresh && s.last_refresh !== '0001-01-01T00:00:00Z') {
            lineEl.textContent = 'ä¸Šæ¬¡åˆ·æ–°: ' + utils.formatTimeAgo(s.last_refresh);
            lineEl.title = utils.formatTimeLocal(s.last_refresh);
            return;
          }

          lineEl.textContent = 'ç­‰å¾…é¦–æ¬¡åˆ·æ–°';
        },

        configList: () => {
          const container = document.getElementById('configList');
          container.innerHTML = '';

          if (state.configNodes.length === 0) {
            document.getElementById('configEmpty').style.display = 'block';
            document.getElementById('subscriptionHint').style.display = 'none';
            return;
          }
          document.getElementById('configEmpty').style.display = 'none';

          const hasSubscription = state.configNodes.some(n => n && n.source === 'subscription');
          document.getElementById('subscriptionHint').style.display = hasSubscription ? 'block' : 'none';

          const frag = document.createDocumentFragment();

          state.configNodes.forEach((n) => {
            const item = document.createElement('div');
            item.className = 'config-item';

            const left = document.createElement('div');

            const nameWrap = document.createElement('div');
            nameWrap.style.display = 'flex';
            nameWrap.style.alignItems = 'center';
            nameWrap.style.flexWrap = 'wrap';

            const name = document.createElement('div');
            name.style.fontWeight = '700';
            name.textContent = n.name || '';
            nameWrap.appendChild(name);

            if (n.source) {
              const source = String(n.source);
              const badge = document.createElement('span');
              badge.className = `config-source-badge ${source.replace(/_/g, '-')}`;
              badge.textContent = source === 'nodes_file' ? 'file' : source;
              nameWrap.appendChild(badge);
            }

            const uri = document.createElement('div');
            uri.className = 'config-uri';
            uri.textContent = n.uri || '';
            uri.title = n.uri || '';

            left.appendChild(nameWrap);
            left.appendChild(uri);

            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.gap = '0.5rem';

            const readOnly = n.source === 'subscription';

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-outline btn-sm';
            editBtn.type = 'button';
            editBtn.textContent = 'ç¼–è¾‘';
            editBtn.onclick = () => actions.editConfig(n.name);

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-destructive btn-sm';
            delBtn.type = 'button';
            delBtn.textContent = 'åˆ é™¤';
            delBtn.onclick = () => actions.deleteConfig(n.name);

            if (readOnly) {
              editBtn.disabled = true;
              delBtn.disabled = true;
              editBtn.title = 'è®¢é˜…èŠ‚ç‚¹åªè¯»';
              delBtn.title = 'è®¢é˜…èŠ‚ç‚¹åªè¯»';
            }

            right.appendChild(editBtn);
            right.appendChild(delBtn);

            item.appendChild(left);
            item.appendChild(right);

            frag.appendChild(item);
          });

          container.appendChild(frag);
        },

        debug: () => {
          if (!state.debugStats.nodes) return;
          const d = state.debugStats;

          document.getElementById('debug-calls').textContent = String(d.total_calls || 0);

          const rate = Number.isFinite(d.success_rate) ? d.success_rate : 0;
          const rateEl = document.getElementById('debug-rate');
          rateEl.textContent = rate.toFixed(1) + '%';
          rateEl.className = `stat-value ${rate > 90 ? 'text-success' : rate > 70 ? 'text-warning' : 'text-destructive'}`;

          document.getElementById('debugGrid').innerHTML = (d.nodes || []).map(n => {
            const total = (n.success_count || 0) + (n.failure_count || 0);
            const succ = total ? ((n.success_count / total) * 100).toFixed(1) : '0.0';
            return `<div class="card">
              <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
                <span class="font-mono text-sm">${utils.esc(n.tag)}</span>
                <span class="font-mono text-sm ${Number(succ) > 90 ? 'text-success' : 'text-warning'}">${succ}%</span>
              </div>
              <div class="text-muted text-sm">Success: ${n.success_count || 0} / Fail: ${n.failure_count || 0}</div>
            </div>`;
          }).join('');
        },

        filterNodes: () => {
          state.filter = document.getElementById('searchInput').value;
          state.sortBy = document.getElementById('sortSelect').value;
          render.monitor();
        }
      };

      const actions = {
        init: async () => {
          ui.modals.bind();
          ui.tabs.bind();

          try {
            const data = await api.getNodes();
            state.isAuthenticated = true;
            state.nodes = data.nodes || [];

            document.getElementById('connectionDot').classList.add('active');
            document.getElementById('lastUpdated').textContent = 'æ›´æ–°äº ' + new Date().toLocaleTimeString('zh-CN');

            render.monitor();
            actions.loadSubscriptionStatus();
            actions.startAutoRefresh(false);
          } catch (e) {
            // api.request å·²å¤„ç† toast / auth.require
          }
        },

        refresh: async () => {
          if (!state.isAuthenticated) return;
          if (state.refreshInFlight) return;
          if (!document.getElementById('view-monitor').classList.contains('active')) return;
          if (document.hidden) return;

          state.refreshInFlight = true;
          try {
            const data = await api.getNodes();
            state.nodes = data.nodes || [];

            document.getElementById('connectionDot').classList.add('active');
            document.getElementById('lastUpdated').textContent = 'æ›´æ–°äº ' + new Date().toLocaleTimeString('zh-CN');

            render.monitor();

            if (Date.now() - state.subscriptionLastFetch > 60000) {
              actions.loadSubscriptionStatus();
            }
          } catch (e) {
            document.getElementById('connectionDot').classList.remove('active');
            document.getElementById('lastUpdated').textContent = 'è¿æ¥å¤±è´¥';
          } finally {
            state.refreshInFlight = false;
          }
        },

        startAutoRefresh: (immediate = true) => {
          if (immediate) actions.refresh();
          if (state.autoRefreshTimer) clearInterval(state.autoRefreshTimer);
          state.autoRefreshTimer = setInterval(() => {
            if (!state.isAuthenticated) return;
            if (document.hidden) return;
            if (!document.getElementById('view-monitor').classList.contains('active')) return;
            actions.refresh();
          }, 15000);
        },

        probeSingle: async (tag) => {
          utils.toast(`æ­£åœ¨æ¢æµ‹ ${tag}...`, 'info');
          try {
            await api.probe(tag);
          } finally {
            actions.refresh();
          }
        },

        releaseSingle: async (tag) => {
          try {
            await api.release(tag);
            utils.toast('å·²è§£é™¤å°ç¦', 'success');
          } finally {
            actions.refresh();
          }
        },

        probeAll: async () => {
          if (!state.isAuthenticated) return;
          if (state.probeAllInFlight) return;
          state.probeAllInFlight = true;

          utils.toast('å¼€å§‹æ‰¹é‡æ¢æµ‹', 'info');
          const bar = document.getElementById('probeFill');
          bar.style.width = '0%';

          try {
            const res = await fetch('/api/nodes/probe-all', { method: 'POST' });

            if (res.status === 401) {
              app.auth.require();
              throw new Error('Unauthorized');
            }
            if (!res.ok || !res.body) {
              throw new Error(`æ¢æµ‹å¤±è´¥ (${res.status})`);
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';

              for (const line of lines) {
                if (!line.startsWith('data:')) continue;

                const payload = line.slice(5).trim();
                if (!payload) continue;

                let d;
                try { d = JSON.parse(payload); } catch (_) { continue; }

                if (d.type === 'start') {
                  bar.style.width = '0%';
                  continue;
                }
                if (d.type === 'progress' && typeof d.progress === 'number') {
                  bar.style.width = `${d.progress}%`;
                  continue;
                }
                if (d.type === 'complete') {
                  bar.style.width = '100%';
                  utils.toast(
                    `æ¢æµ‹ç»“æŸ: æˆåŠŸ ${d.success}ï¼Œå¤±è´¥ ${d.failed}`,
                    d.failed > 0 ? 'error' : 'success'
                  );
                  setTimeout(() => { bar.style.width = '0%'; }, 800);
                  continue;
                }
              }
            }
          } catch (e) {
            if (e.message !== 'Unauthorized') utils.toast(e.message || 'æ¢æµ‹å‡ºé”™', 'error');
          } finally {
            state.probeAllInFlight = false;
            actions.refresh();
          }
        },

        export: async () => {
          try {
            const res = await fetch('/api/export');
            if (res.status === 401) {
              app.auth.require();
              throw new Error('Unauthorized');
            }
            if (!res.ok) throw new Error(`å¯¼å‡ºå¤±è´¥ (${res.status})`);

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'proxies.txt';
            document.body.appendChild(a);
            a.click();
            a.remove();

            window.URL.revokeObjectURL(url);
            utils.toast('å¯¼å‡ºæˆåŠŸ', 'success');
          } catch (e) {
            if (e.message !== 'Unauthorized') utils.toast(e.message || 'å¯¼å‡ºå¤±è´¥', 'error');
          }
        },

        loadConfig: async () => {
          const data = await api.getConfig();
          state.configNodes = data.nodes || [];
          render.configList();
        },

        deleteConfig: async (name) => {
          const node = state.configNodes.find(n => n && n.name === name);
          if (node && node.source === 'subscription') {
            utils.toast('è®¢é˜…èŠ‚ç‚¹åªè¯»ï¼Œæ— æ³•åˆ é™¤', 'error');
            return;
          }

          if (!confirm(`åˆ é™¤èŠ‚ç‚¹ ${name}?`)) return;
          await api.deleteNode(name);
          actions.loadConfig();
          utils.toast('åˆ é™¤æˆåŠŸ', 'success');
        },

        editConfig: (name) => {
          const n = state.configNodes.find(x => x && x.name === name);
          if (!n) return;

          if (n.source === 'subscription') {
            utils.toast('è®¢é˜…èŠ‚ç‚¹åªè¯»ï¼Œæ— æ³•ç¼–è¾‘', 'error');
            return;
          }

          document.getElementById('nodeEditTarget').value = name;
          document.getElementById('nodeName').value = n.name || '';
          document.getElementById('nodeUri').value = n.uri || '';
          document.getElementById('nodePort').value = n.port || '';
          document.getElementById('modalNodeTitle').textContent = 'ç¼–è¾‘èŠ‚ç‚¹';

          app.ui.modals.open('node');
        },

        saveNode: async (e) => {
          e.preventDefault();

          const oldName = document.getElementById('nodeEditTarget').value;
          const data = {
            name: document.getElementById('nodeName').value,
            uri: document.getElementById('nodeUri').value,
            port: parseInt(document.getElementById('nodePort').value, 10) || 0
          };

          try {
            await api.saveNode(data, !!oldName, oldName);
            app.ui.modals.close();
            utils.toast('ä¿å­˜æˆåŠŸ', 'success');
            actions.loadConfig();
          } catch (_) {}
        },

        reloadConfig: async () => {
          if (!confirm('ç¡®å®šé‡è½½ï¼Ÿè¿™å°†æ–­å¼€æ‰€æœ‰è¿æ¥ã€‚')) return;
          await api.reload();
          utils.toast('é…ç½®å·²é‡è½½', 'success');

          setTimeout(() => {
            actions.refresh();
            if (document.getElementById('view-manage').classList.contains('active')) {
              actions.loadConfig();
            }
          }, 1000);
        },

        loadDebug: async () => {
          try {
            const data = await api.getDebug();
            state.debugStats = data;
            render.debug();
          } catch (_) {}
        },

        openSettings: async () => {
          try {
            const s = await api.getSettings();
            document.getElementById('setExtIp').value = s.external_ip || '';
            document.getElementById('setProbe').value = s.probe_target || '';
            document.getElementById('setCert').checked = !!s.skip_cert_verify;
          } catch (_) {}
        },

        saveSettings: async (e) => {
          e.preventDefault();

          const data = {
            external_ip: document.getElementById('setExtIp').value,
            probe_target: document.getElementById('setProbe').value,
            skip_cert_verify: document.getElementById('setCert').checked
          };

          const resp = await api.saveSettings(data);
          if (resp && resp.need_reload) utils.toast('è®¾ç½®å·²ä¿å­˜ï¼Œè¯ä¹¦è®¾ç½®éœ€é‡è½½ç”Ÿæ•ˆ', 'success');
          else utils.toast('è®¾ç½®å·²ä¿å­˜', 'success');

          app.ui.modals.close();
        },

        loadSubscriptionStatus: async () => {
          if (!state.isAuthenticated) return;
          if (state.subscriptionStatusInFlight) return;

          state.subscriptionStatusInFlight = true;
          try {
            const data = await api.getSubscriptionStatus();
            state.subscription = data || null;
            state.subscriptionLastFetch = Date.now();
            render.subscription();
          } catch (_) {
            // ignore; api.request already handled toast if needed
          } finally {
            state.subscriptionStatusInFlight = false;
          }
        },

        refreshSubscription: async () => {
          if (!state.isAuthenticated) return;
          if (state.subscriptionRefreshInFlight) return;

          let status;
          try {
            status = await api.getSubscriptionStatus();
          } catch (_) {
            status = state.subscription;
          }

          if (!status || !status.enabled) {
            utils.toast('æœªå¯ç”¨è®¢é˜…', 'error');
            render.subscription();
            return;
          }

          if (status.nodes_modified) {
            const confirmed = confirm(
              'âš ï¸ è­¦å‘Šï¼šèŠ‚ç‚¹é…ç½®å·²è¢«ä¿®æ”¹\n\n' +
              'åˆ·æ–°è®¢é˜…å¯èƒ½ä¼šè¦†ç›–æ‚¨å¯¹èŠ‚ç‚¹é…ç½®çš„ä¿®æ”¹ã€‚\n\n' +
              'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
            );
            if (!confirmed) return;
          }

          state.subscriptionRefreshInFlight = true;
          render.subscription();

          try {
            const resp = await api.refreshSubscription();
            const count = resp && typeof resp.node_count === 'number' ? resp.node_count : null;
            utils.toast(
              count !== null ? `è®¢é˜…åˆ·æ–°æˆåŠŸï¼å…± ${count} ä¸ªèŠ‚ç‚¹` : 'è®¢é˜…åˆ·æ–°æˆåŠŸï¼',
              'success'
            );
          } catch (_) {
            // api.request already toasted error
          } finally {
            state.subscriptionRefreshInFlight = false;
            await actions.loadSubscriptionStatus();
            actions.refresh();
          }
        }
      };

      const auth = {
        require: () => {
          state.isAuthenticated = false;
          clearInterval(state.autoRefreshTimer);

          ui.modals.close();

          const overlay = document.getElementById('modal-login');
          overlay.classList.add('open');

          requestAnimationFrame(() => {
            const input = document.getElementById('loginPass');
            if (input) input.focus();
          });
        },

        login: async (e) => {
          e.preventDefault();
          const pwd = document.getElementById('loginPass').value;

          try {
            await api.login(pwd);
            document.getElementById('modal-login').classList.remove('open');
            state.isAuthenticated = true;
            utils.toast('ç™»å½•æˆåŠŸ', 'success');
            actions.startAutoRefresh(true);
            actions.loadSubscriptionStatus();
          } catch (_) {
            requestAnimationFrame(() => {
              const input = document.getElementById('loginPass');
              if (input) input.focus();
            });
          }
        }
      };

      const router = {
        switch: (view) => {
          document.querySelectorAll('.view-section').forEach(panel => {
            const isActive = panel.id === `view-${view}`;
            panel.classList.toggle('active', isActive);
            panel.hidden = !isActive;
          });

          document.querySelectorAll('.tabs-nav [role="tab"]').forEach(tab => {
            const isActive = tab.dataset.view === view;
            tab.classList.toggle('active', isActive);
            tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
            tab.tabIndex = isActive ? 0 : -1;
          });

          if (view === 'monitor') {
            actions.refresh();
            actions.loadSubscriptionStatus();
            return;
          }
          if (view === 'manage') {
            actions.loadConfig();
            return;
          }
          if (view === 'debug') {
            actions.loadDebug();
            return;
          }
        }
      };

      const ui = {
        tabs: {
          _bound: false,
          bind: () => {
            if (ui.tabs._bound) return;
            ui.tabs._bound = true;

            const tablist = document.querySelector('.tabs-nav');
            if (!tablist) return;

            tablist.addEventListener('keydown', (e) => {
              const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
              const idx = tabs.indexOf(document.activeElement);
              if (idx === -1) return;

              let next = null;

              if (e.key === 'ArrowRight') next = (idx + 1) % tabs.length;
              else if (e.key === 'ArrowLeft') next = (idx - 1 + tabs.length) % tabs.length;
              else if (e.key === 'Home') next = 0;
              else if (e.key === 'End') next = tabs.length - 1;

              if (next === null) return;

              e.preventDefault();
              const btn = tabs[next];
              btn.focus();

              const view = btn.dataset.view;
              if (view) router.switch(view);
            });
          }
        },

        modals: {
          _bound: false,

          bind: () => {
            if (ui.modals._bound) return;
            ui.modals._bound = true;

            ['modal-node', 'modal-settings'].forEach((id) => {
              const overlay = document.getElementById(id);
              if (!overlay) return;
              overlay.addEventListener('click', (e) => {
                if (e.target === overlay) ui.modals.close();
              });
            });

            document.addEventListener('keydown', (e) => {
              if (e.key !== 'Escape') return;
              if (document.getElementById('modal-login').classList.contains('open')) return;
              ui.modals.close();
            });
          },

          _focusFirst: (overlayId) => {
            requestAnimationFrame(() => {
              const overlay = document.getElementById(overlayId);
              if (!overlay) return;
              const el = overlay.querySelector('input, select, textarea, button');
              if (el) el.focus();
            });
          },

          open: (name) => {
            const overlayId = `modal-${name}`;
            const overlay = document.getElementById(overlayId);
            if (!overlay) return;

            overlay.classList.add('open');

            if (name === 'settings') {
              actions.openSettings().finally(() => ui.modals._focusFirst(overlayId));
              return;
            }

            ui.modals._focusFirst(overlayId);
          },

          openNode: () => {
            document.getElementById('nodeEditTarget').value = '';
            document.getElementById('nodeName').value = '';
            document.getElementById('nodeUri').value = '';
            document.getElementById('nodePort').value = '';
            document.getElementById('modalNodeTitle').textContent = 'æ·»åŠ èŠ‚ç‚¹';
            ui.modals.open('node');
          },

          close: () => {
            ['modal-node', 'modal-settings'].forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.classList.remove('open');
            });
          }
        }
      };

      return { init: actions.init, router, auth, actions, render, ui };
    })();

    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>